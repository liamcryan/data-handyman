<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
         
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Python Gmail - part 2</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: beige;
    }

    :root {
        --accent: brown;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/css/posts.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106240485-1', 'auto');
  ga('send', 'pageview');

</script>
 <meta name="generator" content="Hugo 0.26" />
        
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Python Gmail - part 2</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                                <li><a href="/contact/">Contact</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:liam@data-handyman.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/liamcryan/"><i class="fa fa-github"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/post/python-gmail2/">Python Gmail - part 2</a></h4>
    
    
    <h5>October 9, 2017</h5>
    

     <kbd class="item-tag">gmail</kbd>  <kbd class="item-tag">python</kbd>  <kbd class="item-tag">find</kbd> 

</div>


    <br> <div class="text-justify">

<h2 id="gmail-and-python-part-2">Gmail and Python (part 2)</h2>

<p>Last time we went over the required steps for getting Python to interact with
Gmail.  They are:</p>

<p>1)  <a href="/post/python-gmail1/#2-step-authentication">Enable 2 step authentication</a></p>

<p>2)  <a href="/post/python-gmail1/#app-password">Create an app password</a></p>

<h3 id="finally-let-s-get-to-the-data">Finally! Let&rsquo;s get to the data!</h3>

<p>I want to go over how to get a Formspree email and then send a response to the
sender.  To search for an email we will be using the imaplib library, and to send,
we&rsquo;ll use the smtplib library.</p>

<h3 id="login-using-imaplib">Login using imaplib</h3>

<pre><code class="language-python">&gt;&gt;&gt; import imaplib
&gt;&gt;&gt; m = imaplib.IMAP4_SSL(&quot;imap.gmail.com&quot;)
&gt;&gt;&gt; m.login(&quot;data.handyman.01@gmail.com&quot;, &quot;my_app_password&quot;)
('OK', [b'data.handyman.01@gmail.com authenticated (Success)'])
</code></pre>

<p>OK, looks like I was able to login!</p>

<h3 id="select-the-formspree-label-the-formspree-folder">Select the Formspree label (the Formspree folder)</h3>

<p>Now, I&rsquo;ll select the label I created (within Gmail itself),
the &lsquo;Formspree&rsquo; label (which is basically like a folder).</p>

<pre><code class="language-python">&gt;&gt;&gt; m.select(&quot;Formspree&quot;)
('OK', [b'1'])
</code></pre>

<p>As I selected the Formspree label, the response was OK and [b&rsquo;1&rsquo;].  The
[b&rsquo;1&rsquo;] part of the reponse is telling me that I have 1 email in this label and
it is identified by &lsquo;1&rsquo;.</p>

<h3 id="grab-the-formspree-email">Grab the Formspree email</h3>

<p>The email I am looking for is identified by &lsquo;1&rsquo;, so I want to use this information
to find the Formspree email.</p>

<pre><code class="language-python">message = m.fetch(b'1', '(RFC822)')
</code></pre>

<p>The response is very long so I won&rsquo;t put it here.  Some of the things I need from
the &lsquo;message&rsquo; variable are:</p>

<ol>
<li><p>The sender&rsquo;s name</p></li>

<li><p>The sender&rsquo;s email address</p></li>

<li><p>The sender&rsquo;s subject</p></li>
</ol>

<p>Here is an image of the opened Formspree email.</p>

<p><img src="/img/simplgmail2-2.png"> </img></p>

<ul>
<li><p>The sender&rsquo;s email address in this case is <strong>&lsquo;cryan.liam@gmail.com&rsquo;</strong></p></li>

<li><p>The subject I am looking for is <strong>&lsquo;This is a test&rsquo;</strong></p></li>
</ul>

<p>Not to be confused with the actual sender <strong><em>submissions@formspree.io</em></strong>, and the
actual subject <strong><em>New submission from data-handyman.com/contact/</em></strong>.</p>

<h3 id="finding-the-sender-s-data">Finding the sender&rsquo;s data</h3>

<p>A fairly simple way of obtaining sender&rsquo;s name, email and subject involves converting
the message to a string, then using the find method for the fields we want.  Here is
what that looks like:</p>

<pre><code class="language-python">&gt;&gt;&gt; msg = str(message[1][0][1])
&gt;&gt;&gt; a = msg.find(&quot;name:&quot;)
&gt;&gt;&gt; msg[a:a+100]
'name:\\r\\nLiam Cryan\\r\\n\\r\\n\\r\\nemail:\\r\\ncryan.liam@gmail.com\\r\\n\\r\\n\\r\\nsubject:\\r\\nThis is a test\\'
</code></pre>

<p>It looks like there is a pattern:</p>

<ul>
<li><p><strong>&lsquo;name:&rsquo;</strong></p></li>

<li><p><strong>&lsquo;\r\n&rsquo;</strong></p></li>

<li><p><strong>&lsquo;Liam Cryan&rsquo;</strong></p></li>

<li><p><strong>&lsquo;\r\n\r\n\r\n&rsquo;</strong></p></li>

<li><p><strong>&lsquo;email:&rsquo;</strong></p></li>

<li><p><strong>&hellip;etc&hellip;</strong></p></li>
</ul>

<p>Let&rsquo;s see if this pattern holds true for all of the fields I want.</p>

<pre><code class="language-python">&gt;&gt;&gt; a = msg.find(&quot;name:\\r\\n&quot;)
&gt;&gt;&gt; b = msg.find(&quot;email:\\r\\n&quot;)
&gt;&gt;&gt; c = msg.find(&quot;subject:\\r\\n&quot;)
&gt;&gt;&gt; d = msg.find(&quot;message:\\r\\n&quot;)
&gt;&gt;&gt; msg[a+len('name:\\r\\n'):b-len('\\r\\n\\r\\n\\r\\n')]
'Liam Cryan'
</code></pre>

<p>Yes!  It looks like we got the sender&rsquo;s name.  Let&rsquo;s try the rest:</p>

<pre><code class="language-python">&gt;&gt;&gt; msg[b+len('email:\\r\\n'):c-len('\\r\\n\\r\\n\\r\\n')]
'cryan.liam@gmail.com'
&gt;&gt;&gt; msg[c+len('subject:\\r\\n'):d-len('\\r\\n\\r\\n\\r\\n')]
'This is a test'
</code></pre>

<p>Awesome!  The pattern worked and we are able to get all of the fields we wanted!</p>

<h3 id="sending-a-response-email">Sending a response email</h3>

<p>Now we will be switching gears to the smtplib.  Using the data that we have collected
with the imaplib, we will send an email.</p>

<p>I want to send an email that looks something like:</p>

<ul>
<li><p>subject:  <strong>&ldquo;This is a test&rdquo;</strong></p></li>

<li><p>body:  &lsquo;Hi <strong>&ldquo;Liam Cryan&rdquo;</strong>, thanks for your email.  I&rsquo;ll be getting back to you shortly,
and look forward to talking with you.&rsquo;</p></li>
</ul>

<h3 id="logging-in-with-smtplib">Logging in with smtplib</h3>

<pre><code class="language-python">&gt;&gt;&gt; import smtplib
&gt;&gt;&gt; s = smtplib.SMTP('smtp.gmail.com:587')
&gt;&gt;&gt; s.starttls()
&gt;&gt;&gt; s.login(&quot;data.handyman.01@gmail.com&quot;, &quot;my_app_password&quot;)
(235, b'2.7.0 Accepted')
</code></pre>

<p>Wow, this is going really well.  Let&rsquo;s try sending the email.</p>

<h3 id="actually-sending-the-email">Actually sending the email</h3>

<p>Earlier we figured out who to send the email to and also the subject.</p>

<pre><code class="language-python">&gt;&gt;&gt; send_to = msg[b+len('email:\\r\\n'):c-len('\\r\\n\\r\\n\\r\\n')]
&gt;&gt;&gt; send_subject = msg[c+len('subject:\\r\\n'):d-len('\\r\\n\\r\\n\\r\\n')]
&gt;&gt;&gt; send_name = msg[a+len('name:\\r\\n'):b-len('\\r\\n\\r\\n\\r\\n')]
&gt;&gt;&gt; print((send_to, send_subject, send_name))
('cryan.liam@gmail.com' 'This is a test', 'Liam Cryan')
</code></pre>

<p>smtplib has a method, sendmail, which is used to send emails.  It does not
take a subject as a parameter, but instead can be placed within the message.  Here
is what I am talking about:</p>

<pre><code class="language-python">message = &quot;Subject:{}\n\nHi {}, thanks for your email.  I'll be getting back to you shortly and look forward to talking with you&quot;.format(send_subject, send_name)
&gt;&gt;&gt; s.sendmail(from_addr=&quot;data.handyman.01@gmail.com&quot;, to_addrs=send_to, msg=message)
{}
</code></pre>

<h3 id="checking-that-it-worked">Checking that it worked</h3>

<p>Let&rsquo;s go back to the imaplib and select the &lsquo;Sent Mail&rsquo; label to check that the message sent.</p>

<p>Logging in again:</p>

<pre><code class="language-python">&gt;&gt;&gt; import imaplib
&gt;&gt;&gt; m = imaplib.IMAP4_SSL(&quot;imap.gmail.com&quot;)
&gt;&gt;&gt; m.login(&quot;data.handyman.01@gmail.com&quot;, &quot;my_app_password&quot;)
('OK', [b'data.handyman.01@gmail.com authenticated (Success)'])
</code></pre>

<p>Selecting the &lsquo;Sent Mail&rsquo; label:</p>

<pre><code class="language-python">&gt;&gt;&gt; m.select('&quot;[Gmail]/Sent Mail&quot;')
('OK', [b'10'])
</code></pre>

<p>I selected [Gmail]/Sent Mail&hellip;weird right?  Well you can list out all of the labels using:</p>

<pre><code class="language-python">&gt;&gt;&gt; m.list()[1]
[b'(\\HasNoChildren) &quot;/&quot; &quot;Formspree&quot;', b'(\\HasNoChildren) &quot;/&quot; &quot;INBOX&quot;', b'(\\HasChildren \\Noselect) &quot;/&quot; &quot;[Gmail]&quot;', b'(\\All \\HasNoChildren) &quot;/&quot; &quot;[Gmail]/All Mail&quot;', b'(\\Drafts \\HasNoChildren) &quot;/&quot; &quot;[Gmail]/Drafts&quot;', b'(\\HasNoChildren \\Important) &quot;/&quot; &quot;[Gmail]/Important&quot;', b'(\\HasNoChildren \\Sent) &quot;/&quot; &quot;[Gmail]/Sent Mail&quot;', b'(\\HasNoChildren \\Junk) &quot;/&quot; &quot;[Gmail]/Spam&quot;', b'(\\Flagged \\HasNoChildren) &quot;/&quot; &quot;[Gmail]/Starred&quot;', b'(\\HasNoChildren \\Trash) &quot;/&quot; &quot;[Gmail]/Trash&quot;']
</code></pre>

<p>Look!  the label is called [Gmail]/Sent Mail.  Also weird is that I needed to have single quotes
around the double quotes &lsquo;&rdquo;[Gmail]/Sent Mail&rdquo;&lsquo;.  I kept getting errors until I put the single
quotes around the double quotes.</p>

<p>Grab the most recently sent email (the 10th):</p>

<pre><code class="language-python">&gt;&gt;&gt; sent_message = m.fetch(b'10', '(RFC822)')
&gt;&gt;&gt; str(sent_message[1][0][1]).find(&quot;cryan.liam@gmail.com&quot;)
7
&gt;&gt;&gt; str(sent_message[1][0][1]).find(&quot;This is a test&quot;)
609
&gt;&gt;&gt; str(sent_message[1][0][1]).find(&quot;Hi Liam Cryan,&quot;)
631
&gt;&gt;&gt; str(sent_message[1][0][1]).find(&quot;I'll be getting back to you shortly and look forward to talking with you&quot;)
670
</code></pre>

<p>All right!  We have just verified that the email was sent.  We found the sender email,
the sender subject, the sender name, and the message we wrote to the sender in
the sent email!</p>

<h3 id="thoughts-on-gmail-and-python">Thoughts on Gmail and Python</h3>

<p>Being able to automatically send someone an email after they contact you is really
cool.  A lot of apps and services use some sort of emailing system to contact you
automatically.  I want to go one step further and make sure I actually get back to
the sender.  Imagine I send an automatic email when you contact me saying I will contact you soon, but I never do!
That&rsquo;s not cool.  I think I have a fun solution that will help me respond to
a sender.</p>

<h3 id="google-calendar">Google Calendar</h3>

<p>Yes, Google Calendar, why not?  I originally thought about organizing
the sender&rsquo;s data in Google Sheets, but Google Calendar just sounds more
fun and interactive.  I have never used the Google Calendar API, but I know
there will be more set up.  I also want the reminder to have some information such as:</p>

<ul>
<li><em>sender email address</em></li>
<li><em>sender subject</em></li>
<li><em>sender message</em></li>
<li><em>when I need to follow up</em></li>
</ul>

<p>I think the next post will need to be called Python Google Calendar.  Looking forward
to next time!</p>
</div>

    
    

    

        <h4 class="page-header">Related</h4>

         <div class="item">

    
    
    

    
    

    <h4><a href="/post/python-gmail1/">Python Gmail - part 1</a></h4>
    
    
    <h5>September 15, 2017</h5>
    

     <kbd class="item-tag">gmail</kbd>  <kbd class="item-tag">python</kbd>  <kbd class="item-tag">set-up</kbd> 

</div>
 

    

    

        

        <h4 class="page-header">Comments</h4>

        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "data-handyman" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
        
    

</main>

        <footer>

            

        </footer>

    </body>

</html>

